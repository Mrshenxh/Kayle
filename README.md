# Kayle

核心功能

1、版本回归成果可视化
2、和客户端耦合的核心接口梳理存储，并利用现有平台自动化测试

--------------------------------------------------------------------

平台操作步骤

平台操作整体分为以下三个阶段：

1、建立连接，上传匹配的核心接口
2、创建版本测试计划
3、连接代理，在计划时间内，用计划版本测试包回归测试。

--------------------------------------------------------------------
一、建立连接

创建代理

类似于Charles，我们要上传核心接口，仍然需要每个人建立一个相对应的核心端口:



三个参数含义如下：

代理Port：填写你要代理的端口号，类似Charles上的端口号，如8888，8889

筛选host：选择你要筛选抓取的host，如api.zhihu.com

代理时间：选择此次代理的截止时间(选择截止时间后，在截止时间外，平台会kill掉此端口，关闭mitmproxy；你也可以手动关闭此代理)

代理连接

创建代理成功后，进入mitmproxy代理页面

此时已经创建mitmproxy代理成功，可以用手机连接代理了。

手机连接同Charles连接，操作步骤如下：

1、Pirate-ship局域网下，连接代理IP：10.101.1.51  端口号：填写你刚刚填写的代理Port

2、浏览器打开 mitm.it，出现以下画面(Android端部分机型建议用第三方浏览器打开):

3、选择相对应的设备证书，点击下载安装并信任(此步为了抓取https连接，类似Charles下载根证书)。

4、证书安装成功后，此时再打开相应APP，就可以开心抓取数据啦。

--------------------------------------------------------------------

抓包数据交互

筛选：抓包看到的数据，可以操作筛选，包括URL，应用，请求方式等。只需建立一定筛选规则即可。

查看详情：每个接口Item，点击“查看详情”，即展示接口详细数据，包括请求头，请求数据，返回数据，接口耗时等。

接口上传：抓到核心接口后，可以操作上传为核心接口：

1、接口名称：自动回填，也可以自定义修改。

2、匹配正则：即填写接口要匹配的正则表达式。举例如下：

场景一：

接口为：https://api.test.com/aaa

则正则表达式写：https://api.test.com/aaa 即可

场景二：

接口为：https://api.test.com/aaa?offset=20&limit=1

则正则表达式写：https://api.test.com/aaa\?offset=\d{1,3}&limit=\d{1,3} 即可

原则就是，正则表达式可以匹配的接口有且只有一则数据即可。

正则表达式学习/测试地址可以参考：

正则表达式匹配

https://tool.oschina.net/regex/

正则表达式匹配说明

http://tools.jb51.net/regex/create_reg

3、所属业务：选择接口所属业务

4、接口描述：填写接口请求时机即可，如“市场Tab feed流，点击换一换”

填写完毕之后，点击“确认上传”。上传成功后，在“接口列表”里查看是否上传成功

--------------------------------------------------------------------

核心接口交互

筛选：核心接口列表同样支持筛选，包括URL，业务模块等

删除，编辑：核心接口列表支持二次编辑，删除功能

--------------------------------------------------------------------

二、测试计划

创建测试计划

当没有测试计划时，测试计划Tab默认展示无测试计划样式

点击“新建计划”，进入创建测试计划页面

其中参数说明如下：

测试版本：填写本次发车回归的APP版本即可，如7.3.0等，注意不要有空格等额外字符。

业务范围：选择本次计划覆盖的业务模块，如选择“内容&会员”后，本次计划将会匹配“内容&会员”模块下所有的核心接口(可支持多选)。

开始时间：选择计划开始时间，只有在计划时间内，才会操作匹配。

结束时间：选择计划结束时间，只有在计划时间内，才会操作匹配。

点击创建计划，则计划创建完成。

会将创建计划task加入到celery的任务队列中，过几秒钟切换下Tab即可看到计划展示

回归计划页面：

1、展示计划创建的相关信息

2、可以查看所有接口以及未匹配接口

3、可以根据接口负责人搜索名下接口

4、可以操作关闭计划


历史计划

创建计划页面，点击“历史计划”，会进入到历史计划页面，用户可以看到所有之前创建过的历史计划

历史计划页面，用户可删除历史计划，点击“查看详情”，正常进入到历史计划详情页

历史计划详情页可查看数据和之前展示一致。

--------------------------------------------------------------------

三、计划内测试

当计划开始后，用户连接代理，上传的接口会被筛选匹配，匹配成功，则展示匹配成功信息，包括系统、版本、机型等内容

其中，如果多个设备命中某个接口规则，就会展示多个设备信息。

测试计划会在结束时间后，由定时任务自动置为“已结束”状态

至此，我们就可以清晰的根据接口覆盖率，接口覆盖模块，及时查找到还没覆盖到的功能，进行高效的回归测试啦。

--------------------------------------------------------------------

后记

关于凯尔

凯尔取自英雄联盟中著名的上单英雄Kayle，是一名集治疗、加速、减速、伤害免疫于一身的古老、稳定、高效的上分利器。特点就是前中期稳定发育，后期带领团队走向胜利。项目寓意即在版本上线后期(灰度回归阶段)，通过建立可视化的回归计划，让回归场景全面覆盖，保证项目最终的高质量上线。

--------------------------------------------------------------------

项目结构&部署详见：

前端：https://www.jianshu.com/p/6dcecddb701d
后端：https://www.jianshu.com/p/9c8ac4fff52d
项目部署：
